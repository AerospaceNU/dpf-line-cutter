/*
    MS5xxx.h - Library for accessing MS5xxx sensors via I2C
    Copyright (c) 2012 Roman Schmitz

    This file is part of arduino-ms5xxx.

    arduino-ms5xxx is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    arduino-ms5xxx is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with arduino-ms5xxx.  If not, see <http://www.gnu.org/licenses/>.

*/

#include "MS5xxx.h"

MS5xxx::MS5xxx(TwoWire *aWire) : i2caddr(I2C_MS5607) {
  _Wire = aWire;
}

void MS5xxx::setI2Caddr(char aAddr) {
  i2caddr = aAddr;
}

byte MS5xxx::send_cmd(byte aCMD)
{
  _Wire->beginTransmission(i2caddr);
  _Wire->write(aCMD);
  uint8_t ret = _Wire->endTransmission(true);
  return ret;
}

uint8_t MS5xxx::connect() {
  _Wire->beginTransmission(i2caddr);
  uint8_t ret = _Wire->endTransmission(true);
  return ret;
}

void MS5xxx::ReadProm() {
  send_cmd(MS5xxx_CMD_RESET);
  delay(3);

  for (uint8_t i = 0; i < 8; i++)
  {
    C[i] = 0x0000;
    send_cmd(MS5xxx_CMD_PROM_RD + 2 * i);
    _Wire->requestFrom(i2caddr, 2);

    unsigned int c = _Wire->read();
    C[i] = (c << 8);
    c = _Wire->read();
    C[i] += c;
  }

}

unsigned int MS5xxx::Calc_CRC4(unsigned char poly)
{
  int cnt;                   		// simple counter
  unsigned int n_rem;                 // CRC remainder
  unsigned int crc_read;              // original value of the CRC
  unsigned int l_pol = poly;
  unsigned char n_bit;

  l_pol = ( l_pol << 8 ) & 0xf000;	// shift bits and apply mask
  n_rem = 0x0000;

  crc_read = C[ 7 ];                  // save read RCR
  C[ 7 ] = ( 0xFF00 & ( C[ 7 ] ) );   // CRC byte is replaced by 0
  for ( cnt = 0; cnt < 16; cnt++ )    // operation is performed on bytes
  { // choose LSB or MSB
    if ( cnt % 2 == 1 ) n_rem ^= ( unsigned short ) ( ( C[ cnt >> 1 ] ) & 0x00FF );
    else n_rem ^= ( unsigned short ) ( ( C[ cnt >> 1 ] >> 8) & 0x00FF );

    for ( n_bit = 8; n_bit > 0; n_bit-- )
    {
      if ( n_rem & ( 0x8000 ) )
      {
        n_rem = ( n_rem << 1 ) ^ l_pol;
      }
      else
      {
        n_rem = ( n_rem << 1 );
      }
    }
  }
  C[ 7 ] = crc_read;
  n_rem = (0x000F & (n_rem >> 12)); // final 4-bit remainder is CRC code
  return n_rem;
}

unsigned int MS5xxx::Read_CRC4()
{

  unsigned int crc_read = ( 0x000F & ( C[ 7 ] ) );
  return ( crc_read );
}

unsigned int MS5xxx::Read_C( unsigned int index)
{
  unsigned int retval = 0;
  if ( ( index >= 0) && ( index <= 7 ) )
    retval = C[ index ];
  return retval;
}

unsigned long MS5xxx::read_adc(unsigned char aCMD)
{
  unsigned long value = 0;
  unsigned long c = 0;

  send_cmd(MS5xxx_CMD_ADC_CONV + aCMD); // start DAQ and conversion of ADC data
  switch (aCMD & 0x0f)
  {
    case MS5xxx_CMD_ADC_256 : delayMicroseconds(900);
      break;
    case MS5xxx_CMD_ADC_512 : delay(3);
      break;
    case MS5xxx_CMD_ADC_1024: delay(4);
      break;
    case MS5xxx_CMD_ADC_2048: delay(6);
      break;
    case MS5xxx_CMD_ADC_4096: delay(10);
      break;
  }
  send_cmd(MS5xxx_CMD_ADC_READ); // read out values
  _Wire->requestFrom(i2caddr, 3);
  c = _Wire->read();
  value = (c << 16);
  c = _Wire->read();
  value += (c << 8);
  c = _Wire->read();
  value += c;

  return value;
}

void MS5xxx::Readout() {
  unsigned long D1 = 0, D2 = 0;

  double dT;
  double OFF;
  double SENS;

  D2 = read_adc(MS5xxx_CMD_ADC_D2 + MS5xxx_CMD_ADC_4096);
  D1 = read_adc(MS5xxx_CMD_ADC_D1 + MS5xxx_CMD_ADC_4096);

  // calculate 1st order pressure and temperature (MS5607 1st order algorithm)
  dT = D2 - C[5] * pow(2, 8);
  OFF = C[2] * pow(2, 17) + dT * C[4] / pow(2, 6);
  SENS = C[1] * pow(2, 16) + dT * C[3] / pow(2, 7);
  TEMP = (2000 + (dT * C[6]) / pow(2, 23));
  P = (((D1 * SENS) / pow(2, 21) - OFF) / pow(2, 15));

  // perform higher order corrections
  double T2 = 0., OFF2 = 0., SENS2 = 0.;
  if (TEMP < 2000) {
    T2 = dT * dT / pow(2, 31);
    OFF2 = 61 * (TEMP - 2000) * (TEMP - 2000) / pow(2, 4);
    SENS2 = 2 * (TEMP - 2000) * (TEMP - 2000);
    if (TEMP < -1500) {
      OFF2 += 15 * (TEMP + 1500) * (TEMP + 1500);
      SENS2 += 8 * (TEMP + 1500) * (TEMP + 1500);
    }
  }

  TEMP -= T2;
  OFF -= OFF2;
  SENS -= SENS2;
  P = (((D1 * SENS) / pow(2, 21) - OFF) / pow(2, 15));
}

double MS5xxx::GetTemp() {
  return TEMP;
}


const uint32_t pressure_array[4100] = {100919,100916,100920,100916,100919,100913,100920,100912,100914,100916,100913,100918,100914,100912,100912,100914,100916,100912,100915,100915,100917,100916,100918,100919,100914,100918,100913,100912,100920,100917,100917,100914,100916,100916,100921,100918,100915,100919,100914,100918,100913,100912,100915,100914,100917,100917,100916,100917,100916,100916,100917,100916,100915,100919,100914,100921,100917,100917,100918,100918,100924,100915,100918,100917,100916,100914,100914,100916,100913,100915,100917,100917,100915,100914,100918,100915,100916,100913,100920,100918,100918,100914,100916,100917,100916,100923,100916,100914,100916,100912,100913,100919,100919,100918,100916,100919,100914,100917,100917,100917,100912,100915,100917,100914,100912,100918,100919,100917,100915,100918,100913,100915,100920,100916,100915,100914,100916,100917,100913,100921,100918,100920,100917,100916,100919,100918,100913,100917,100917,100912,100913,100916,100917,100920,100915,100914,100918,100917,100917,100918,100916,100917,100917,100919,100920,100910,100916,100915,100915,100916,100916,100916,100915,100912,100912,100914,100919,100917,100919,100917,100916,100916,100910,100914,100910,100917,100917,100922,100917,100917,100916,100920,100918,100916,100918,100919,100917,100919,100917,100914,100914,100918,100918,100918,100921,100914,100916,100919,100916,100912,100914,100917,100915,100914,100916,100913,100913,100919,100918,100917,100916,100913,100917,100921,100916,100916,100918,100914,100920,100917,100916,100916,100913,100917,100919,100917,100915,100918,100919,100918,100920,100915,100920,100919,100916,100916,100916,100920,100915,100917,100921,100917,100920,100917,100918,100913,100919,100911,100916,100917,100911,100917,100920,100918,100915,100913,100915,100919,100920,100916,100918,100913,100918,100913,100915,100917,100918,100920,100917,100917,100915,100919,100919,100913,100916,100916,100916,100912,100922,100920,100916,100917,100914,100920,100911,100919,100921,100916,100919,100917,100917,100919,100914,100918,100917,100916,100918,100917,100917,100916,100918,100915,100917,100918,100915,100918,100916,100912,100917,100917,100912,100916,100917,100917,100914,100911,100918,100919,100915,100916,100915,100915,100921,100916,100913,100915,100916,100917,100916,100915,100913,100914,100919,100919,100919,100916,100919,100920,100920,100918,100917,100914,100911,100917,100914,100919,100917,100917,100916,100908,100913,100913,100913,100915,100917,100916,100914,100918,100912,100914,100913,100917,100915,100915,100916,100913,100918,100914,100914,100914,100916,100918,100914,100916,100911,100917,100913,100913,100918,100914,100916,100915,100911,100921,100916,100914,100913,100918,100920,100916,100914,100914,100914,100914,100913,100918,100915,100916,100916,100916,100916,100914,100915,100915,100915,100918,100913,100914,100915,100912,100920,100914,100913,100913,100918,100914,100913,100909,100917,100908,100916,100916,100918,100917,100916,100914,100913,100917,100920,100915,100916,100918,100918,100913,100918,100914,100915,100912,100915,100915,100920,100915,100915,100911,100914,100912,100916,100917,100914,100915,100918,100916,100915,100914,100920,100913,100915,100918,100913,100912,100918,100907,100917,100914,100913,100916,100915,100917,100920,100912,100916,100917,101214,100937,100916,100890,100867,100844,100815,100777,100722,100671,100614,100548,100478,100399,100322,100227,100127,100031,99939,99846,99752,99645,99517,99366,99211,99090,98994,98885,98768,98666,98541,98498,98430,98349,98294,98230,98179,98129,98084,98017,97941,97870,97817,97766,97713,97652,97589,97523,97468,97417,97349,97305,97249,97175,97103,97052,96987,96927,96872,96808,96748,96687,96630,96559,96501,96445,96380,96334,96279,96215,96158,96100,96046,95996,95940,95891,95835,95786,95728,95665,95619,95573,95521,95466,95416,95368,95313,95261,95205,95168,95115,95067,95013,94966,94913,94872,94824,94779,94723,94679,94627,94578,94535,94487,94443,94397,94357,94306,94269,94225,94183,94134,94085,94041,93999,93953,93915,93873,93837,93788,93748,93706,93666,93626,93589,93546,93504,93472,93426,93397,93353,93311,93273,93241,93205,93165,93132,93092,93047,93017,92978,92946,92912,92878,92843,92802,92772,92741,92702,92676,92634,92608,92572,92542,92509,92481,92445,92414,92384,92357,92320,92288,92257,92230,92203,92172,92145,92116,92084,92048,92023,91997,91975,91948,91925,91896,91868,91835,91816,91788,91754,91736,91710,91681,91659,91632,91609,91592,91574,91548,91519,91496,91476,91454,91432,91411,91391,91370,91344,91321,91305,91287,91262,91243,91225,91203,91184,91164,91145,91127,91112,91096,91076,91056,91043,91024,91006,90989,90973,90954,90947,90931,90912,90893,90886,90869,90850,90837,90826,90814,90803,90787,90774,90765,90751,90740,90728,90722,90704,90700,90688,90672,90667,90654,90643,90633,90627,90615,90609,90599,90585,90574,90573,90566,90557,90547,90539,90538,90527,90525,90520,90507,90505,90498,90495,90488,90484,90483,90479,90474,90467,90466,90464,90458,90455,90457,90451,90446,90445,90444,90446,90443,90439,90442,90441,103187,90677,90505,90442,90463,90465,90484,90503,90503,90493,90495,90491,90491,90496,90499,90510,90511,90515,90516,90517,90530,90540,90564,90623,90636,90626,90645,90663,90693,90691,90637,90652,90697,90723,90743,90798,90810,90860,90730,90740,90768,90779,90795,90797,90838,90829,90842,90867,90868,90880,90880,90884,90905,90901,90883,90889,90924,90938,90945,90927,90919,90879,90883,90861,90836,90846,90816,90786,90810,90824,90843,90827,90826,90861,90887,90901,90903,90949,90948,90992,91008,90946,90985,91050,91101,90799,91041,91062,91010,91111,91100,91098,91120,91070,91096,91115,91110,91200,91134,91256,91255,91232,91263,91169,91222,91161,91260,91319,91334,91233,91310,91466,91435,91497,91450,91386,91351,91388,91334,91420,90342,91308,91318,91423,91508,91482,91470,91381,91425,91432,91491,91483,91496,91486,91493,91493,91509,91553,91547,91584,91598,91608,91627,91691,91719,91746,91733,91711,91760,91747,91771,91750,91799,91797,91814,91835,91826,91822,91797,91845,91846,91857,91841,91915,91903,91934,91920,91923,91930,91928,91960,91964,91963,91986,92012,92006,92018,92007,92021,92037,92048,92057,92064,92078,92101,92106,92111,92117,92147,92131,92159,92151,92150,92169,92198,92198,92207,92226,92199,92200,92214,92246,92263,92275,92254,92282,92322,92335,92310,92280,92322,92325,92385,92358,92366,92396,92426,92409,92412,92421,92448,92431,92415,92436,92472,92510,92519,92503,92513,92541,92545,92530,92524,92544,92551,92524,92499,92519,92569,92594,92521,92523,92563,92648,92652,92624,92290,92541,92364,92261,92269,92206,92501,92231,92630,92355,92608,92320,92658,92582,92629,92679,92736,92783,92717,92744,92799,92716,92734,92652,92771,92761,92665,92743,92850,92770,92783,92713,92949,92887,92878,92889,92964,92967,93025,92998,93030,93038,93004,93061,93073,93087,93095,93112,93091,93097,93111,93110,93106,93114,93126,93144,93159,93135,93127,93195,93219,93185,93195,93199,93237,93243,93260,93245,93264,93278,93279,93313,93309,93304,93319,93333,93312,93356,93075,93271,93079,93428,93351,93394,93393,93434,93494,93507,93544,93528,93559,93556,93590,93581,93581,93596,93604,93645,93640,93635,93645,93676,93687,93701,93684,93697,93696,93726,93728,93714,93795,93780,93792,93781,93841,93836,93852,93831,93868,93859,93872,93879,93890,93893,93895,93918,93930,93945,93960,93959,93946,93958,93967,94014,94019,94021,94040,94045,94056,94063,94096,94098,94097,94115,94123,94130,94142,94162,94146,94162,94177,94189,94200,94231,94242,94238,94250,94262,94270,94278,94289,94310,94311,94324,94329,94317,94340,94336,94357,94375,94358,94383,94396,94418,94393,94419,94419,94450,94433,94454,94480,94475,94491,94482,94513,94512,94511,94534,94543,94558,94550,94572,94562,94577,94610,94614,94631,94643,94651,94667,94664,94680,94680,94688,94690,94716,94712,94742,94724,94739,94739,94767,94778,94784,94794,94780,94821,94819,94837,94837,94893,94890,94879,94895,94884,94898,94891,94925,94909,94921,94918,94953,94973,94962,94998,95016,95033,95029,95033,95039,95026,95059,95069,95071,95058,95069,95070,95121,95130,95154,95162,95181,95186,95195,95204,95205,95214,95236,95248,95238,95223,95228,95254,95283,95288,95294,95309,95332,95340,95348,95349,95360,95367,95368,95372,95386,95401,95397,95401,95411,95427,95434,95436,95450,95467,95474,95480,95493,95502,95521,95542,95530,95574,95562,95591,95568,95596,95588,95614,95602,95609,95636,95635,95633,95643,95647,95662,95647,95698,95693,95722,95737,95747,95753,95747,95761,95762,95775,95813,95818,95819,95842,95842,95885,95887,95882,95883,95882,95907,95908,95914,95935,95964,95948,95956,95975,95991,96019,95975,95979,96015,95929,96117,96049,96036,96076,96070,96064,96099,96086,96089,96097,96086,96110,96111,96122,96120,96156,96150,96151,96171,96162,96180,96195,96192,96205,96231,96220,96221,96244,96251,96250,96275,96276,96279,96299,96303,96313,96312,96319,96322,96331,96332,96341,96347,96362,96365,96373,96374,96382,96391,96392,96397,96414,96416,96425,96429,96439,96438,96440,96437,96448,96439,96439,96442,96450,96455,96466,96454,96466,96470,96471,96475,96481,96493,96502,96510,96512,96521,96523,96541,96557,96567,96573,96583,96590,96597,96600,96605,96607,96623,96635,96648,96660,96674,96679,96693,96699,96702,96722,96724,96740,96742,96750,96759,96765,96774,96785,96796,96794,96814,96814,96838,96843,96852,96858,96863,96878,96884,96902,96904,96918,96926,96917,96938,96939,96959,96964,96957,96974,96969,96970,96981,96993,96999,97009,96968,97098,97015,97009,97021,97010,97024,97005,97012,97013,97009,97023,97017,97023,97020,97025,97028,97037,97047,97051,97061,97065,97075,97053,97068,97072,97078,97077,97081,97092,97091,97100,97091,97103,97109,97103,97100,97102,97109,97107,97109,97121,97103,97080,97121,97112,97104,97142,97146,97165,97178,97164,97173,97174,97179,97177,97187,97191,97183,97178,97174,97179,97182,97184,97197,97199,97210,97206,97208,97211,97223,97224,97231,97234,97235,97238,97247,97243,97249,97250,97256,97259,97249,97259,97272,97269,97283,97274,97269,97286,97277,97277,97292,97299,97293,97299,97318,97312,97294,97298,97307,97296,97325,97331,97326,97345,97347,97351,97350,97356,97359,97362,97362,97368,97374,97376,97369,97380,97385,97383,97387,97397,97395,97386,97393,97398,97399,97411,97417,97414,97410,97397,97406,97403,97420,97420,97416,97436,97427,97437,97444,97438,97461,97462,97459,97445,97452,97472,97482,97480,97481,97487,97495,97491,97481,97484,97499,97522,97524,97529,97529,97529,97525,97532,97544,97548,97545,97538,97537,97514,97526,97554,97569,97578,97585,97578,97577,97581,97580,97594,97602,97609,97612,97603,97604,97614,97618,97619,97625,97629,97632,97633,97641,97641,97639,97659,97660,97663,97668,97671,97681,97676,97683,97683,97685,97685,97699,97708,97706,97709,97717,97720,97727,97716,97725,97721,97713,97722,97747,97733,97742,97739,97741,97761,97752,97752,97762,97786,97781,97794,97785,97785,97793,97797,97796,97798,97815,97817,97800,97797,97823,97823,97819,97826,97823,97824,97822,97824,97836,97842,97854,97856,97865,97858,97866,97865,97875,97874,97870,97882,97889,97900,97899,97906,97911,97922,97925,97925,97930,97923,97929,97930,97922,97947,97947,97947,97956,97956,97968,97970,97976,97980,97978,97977,97980,97982,97984,97992,98005,98003,98008,98023,98026,98015,98019,98019,98016,98025,98028,98025,98022,98027,98028,98020,98033,98037,98030,98048,98061,98063,98064,98070,98085,98081,98089,98089,98086,98091,98092,98092,98098,98094,98105,98107,98119,98119,98122,98129,98128,98134,98135,98123,98151,98147,98147,98136,98114,98153,98173,98168,98173,98171,98175,98160,98178,98189,98189,98180,98191,98193,98193,98206,98202,98199,98214,98211,98216,98216,98214,98220,98221,98229,98224,98237,98244,98248,98218,98221,98247,98257,98253,98257,98259,98256,98257,98243,98251,98259,98277,98281,98279,98287,98286,98262,98301,98309,98295,98289,98314,98291,98293,98314,98316,98302,98309,98309,98281,98287,98298,98281,98266,98305,98320,98336,98339,98357,98361,98351,98369,98379,98389,98404,98390,98378,98411,98418,98412,98418,98433,98410,98428,98444,98450,98451,98457,98465,98455,98459,98491,98490,98477,98483,98501,98507,98511,98519,98526,98534,98532,98537,98526,98547,98536,98534,98512,98470,98539,98559,98538,98526,98503,98567,98519,98543,98537,98580,98505,98561,98583,98553,98596,98596,98572,98597,98627,98606,98608,98613,98611,98619,98583,98633,98598,98621,98652,98633,98589,98640,98639,98641,98653,98638,98621,98649,98671,98675,98675,98652,98618,98624,98661,98666,98663,98633,98656,98705,98707,98692,98691,98719,98701,98696,98733,98738,98730,98713,98716,98754,98755,98748,98749,98768,98776,98778,98779,98771,98794,98803,98797,98780,98787,98806,98816,98814,98794,98793,98817,98844,98836,98828,98841,98852,98854,98845,98845,98862,98871,98870,98880,98881,98888,98892,98889,98899,98901,98904,98914,98906,98868,98899,98898,98895,98898,98888,98895,98896,98892,98914,98932,98940,98943,98951,98959,98962,98965,98971,98984,98983,98988,98991,98988,99002,99012,99011,99018,99023,99034,99033,99038,99040,99043,99048,99059,99055,99062,99069,99075,99086,99081,99076,99079,99083,99091,99092,99103,99093,99072,99099,99112,99125,99127,99118,99119,99124,99128,99132,99138,99143,99135,99136,99140,99147,99145,99146,99151,99165,99159,99146,99154,99170,99152,99147,99162,99178,99176,99189,99197,99199,99207,99210,99207,99222,99221,99211,99233,99235,99227,99240,99253,99260,99265,99276,99272,99285,99288,99294,99289,99292,99294,99311,99318,99311,99320,99334,99338,99348,99351,99360,99353,99367,99379,99386,99384,99379,99399,99422,99400,99421,99417,99428,99428,99424,99422,99414,99422,99437,99434,99437,99422,99471,99467,99429,99447,99484,99490,99483,99492,99448,99468,99488,99486,99484,99481,99510,99520,99538,99541,99542,99546,99551,99551,99549,99555,99566,99560,99576,99574,99583,99568,99571,99567,99549,99519,99542,99554,99572,99586,99604,99611,99628,99626,99625,99629,99632,99650,99659,99679,99663,99682,99694,99700,99700,99695,99701,99719,99725,99727,99733,99743,99743,99747,99758,99758,99756,99774,99786,99790,99787,99788,99804,99807,99804,99816,99814,99814,99816,99830,99843,99831,99860,99866,99873,99872,99881,99888,99893,99888,99896,99898,99900,99914,99912,99904,99904,99920,99887,99902,99908,99949,99959,99962,99982,99979,99973,99986,99997,100007,99997,99977,99984,99991,99990,99965,100007,100018,100018,100022,100021,100025,100049,100059,100074,100070,100080,100083,100089,100097,100099,100101,100102,100108,100117,100114,100118,100127,100130,100135,100124,100126,100131,100123,100127,100124,100148,100155,100155,100157,100154,100167,100183,100196,100191,100195,100200,100195,100206,100209,100193,100204,100207,100203,100217,100212,100219,100232,100235,100243,100248,100248,100239,100265,100268,100264,100270,100294,100298,100278,100305,100319,100318,100317,100331,100337,100340,100346,100355,100361,100360,100366,100371,100380,100383,100391,100390,100399,100417,100421,100414,100424,100430,100430,100428,100427,100433,100421,100411,100406,100467,100488,100481,100489,100480,100496,100497,100494,100494,100498,100491,100502,100504,100504,100506,100525,100531,100529,100540,100557,100561,100564,100563,100563,100563,100566,100566,100573,100578,100588,100597,100597,100605,100605,100617,100618,100618,100623,100628,100622,100628,100626,100624,100623,100640,100664,100667,100651,100659,100672,100679,100682,100675,100683,100685,100679,100688,100700,100693,100690,100707,100714,100715,100722,100726,100733,100713,100727,100731,100726,100739,100733,100728,100738,100751,100754,100773,100762,100760,100767,100766,100770,100791,100795,100797,100792,100795,100795,100796,100793,100799,100796,100792,100792,100801,100801,100805,100805,100804,100806,100808,100809,100813,100818,100815,100821,100818,100826,100826,100825,100827,100828,100834,100839,100843,100845,100855,100870,100884,100895,100913,100916,100918,100927,100916,100923,100922,100922,100920,100922,100916,100921,100926,100919,100923,100913,100918,100920,100912,100917,100917,100918,100916,100918,100917,100919,100914,100917,100914,100921,100918,100918,100921,100917,100918,100918,100918,100921,100919,100918,100919,100923,100916,100919,100922,100920,100924,100917,100923,100925,100918,100918,100920,100914,100922,100924,100920,100921,100918,100920,100921,100918,100923,100919,100921,100923,100917,100923,100919,100918,100920,100922,100917,100918,100920,100926,100918,100920,100921,100922,100918,100922,100913,100917,100921,100918,100920,100917,100918,100919,100917,100917,100919,100922,100920,100920,100921,100921,100918,100918,100920,100923,100918,100924,100918,100921,100921,100917,100921,100920,100918,100925,100924,100922,100918,100924,100919,100919,100922,100923,100919,100921,100922,100917,100920,100922,100921,100917,100925,100918,100924,100919,100920,100922,100922,100919,100924,100920,100919,100918,100919,100919,100919,100919,100923,100924,100921,100923,100922,100923,100918,100922,100921,100921,100922,100925,100921,100923,100919,100919,100922,100927,100920,100925,100918,100923,100919,100922,100916,100920,100920,100919,100924,100919,100922,100920,100920,100919,100923,100920,100924,100924,100921,100926,100920,100919,100923,100923,100917,100925,100920,100921,100923,100920,100922,100917,100920,100920,100922,100923,100922,100924,100918,100925,100917,100921,100922,100921,100921,100919,100921,100922,100917,100923,100924,100919,100922,100920,100924,100921,100920,100923,100917,100920,};
int pressure_idx = 0;

double MS5xxx::GetPres() {
  return pressure_array[min(pressure_idx++,4100-1)];
}

unsigned char MS5xxx::CRCcodeTest() {
  unsigned int nprom[] = {0x3132, 0x3334, 0x3536, 0x3738, 0x3940, 0x4142, 0x4344, 0x4500}; //expected output is 0xB
  for (uint8_t i = 0; i < 8; i++) {
    C[i] = nprom[i];
  }
  unsigned char crc = Calc_CRC4(); //expected output is 0xB
  ReadProm();
  return crc;
}
